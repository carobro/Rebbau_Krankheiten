<!-- @author Carolin Bronowicz
   --- WS 2018/2019
   ---- Kurs: Geodaten
   ---- Thema: Visualisierung mit D3.js
   ---- as a base i used the code from our lecture
   ---- @source https://sso.uni-muenster.de/LearnWeb/learnweb2/mod/resource/view.php?id=1173342
   -->
   <!DOCTYPE html>
   <html>
      <head>
         <meta charset="UTF-8">
         <title>Visualization</title>
         <link rel="shortcut icon" href="sensebox_logo_raute.png" type="image/png" />
         <script src="https://d3js.org/d3.v5.min.js"></script>
         <script src="https://d3js.org/topojson.v1.min.js"></script>
         <style>
            .parts{
            stroke: blue; 
            stroke-width: 2px;
            }
            .parts.hovered{
            fill: yellow;
            }
            .sensebox.hovered{
            fill: #d02090;
            stroke-width: 2;
            stroke: black;
            }   
            .line {
            fill: none;
            stroke: #ffab00;
            stroke-width: 3;
            }
            .dot {
            fill: #ffab00;
            stroke: #fff;
            }
         </style>
      </head>
      <body>
         <script type="text/javascript">
            // svg margin width and height parameters for the muenster map
            var margin = { top: 20, right: 20, bottom: 20, left: 20 };
            var width = 500 - margin.left - margin.right,
              height = 600 - margin.top - margin.bottom;
            
            // svg margin parameters for the diagramm
            var width2 = 900 - margin.left - margin.right,
              height2 = 500 - margin.top - margin.bottom;
            
            // svg parameters for muenster map
            var svg = d3.select("body").append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .style("background", "#ececec")
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            
            // parameters of the svg for the linediagram
            var svg2 = d3.select("body").append("svg")
              .attr("width", width2 + margin.left + margin.right)
              .attr("height", height2 + margin.top + margin.bottom)
              .style("background", "white")
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            
            // currrent projection
            var currentprojection = d3.geoMercator()
              .center([7.6261347, 51.9606649]) //Koordinates from Muenster
              .scale(80000)
              .translate([width / 2, height / 2]);
            
            // geopath                        
            var geopath = d3.geoPath().projection(currentprojection);
            
            // Basemap from https://milchkuehe.carto.com/tables/shapefile_m_nster_stadtteile/public
            d3.json("https://raw.githubusercontent.com/carobro/Geodaten/master/shapefile_m_nster_stadtteile.json")
              .then(function (dataset) {
                console.log(dataset);
                var parts = topojson.feature(dataset, dataset.objects.shapefile_m_nster_stadtteile).features;
                //console.log(parts);
            
                // data binding
                var citypartsshapes = d3.select("svg").selectAll("path").data(parts);
            
                // create paths
                citypartsshapes.enter()
                  .append("path")
                  .attr("d", geopath)
                  .attr("stroke", "blue")
                  .attr("stroke-width", 2)
                  .attr("fill", "orange")
                  .on("mouseover", function (d) {
                    d3.select(this).classed("cityparts hovered", true);
                  })
                  .on("mouseout", function (d) {
                    d3.select(this).classed("cityparts hovered", false);
                  });
            
                  // Air Pressure Data from https://opensensemap.org/
                d3.csv("https://raw.githubusercontent.com/carobro/Geodaten/master/Luftdruck.csv")
                  .then(function (citydataset) {
                    // delimiter for the parser (because my csv was seperated by ",")
                    var parser = d3.dsvFormat(",");
            
                    // format the dataset as csv, and then use the parser to return the data elements
                    var cdataset = parser.parse(d3.csvFormat(citydataset));
                    console.log(cdataset);
                    // data binding
                    var sensor = d3.select("svg").selectAll("circle").data(cdataset);
            
                    //Added the circles for the Senseboxes
                    sensor.enter()
                      .append("circle")
                      .attr("r", 5)
                      .attr("fill", "yellow")
                      .attr("stroke", "#8B7500")
                      .attr("transform", function (d) { return "translate(" + currentprojection([d.lon, d.lat]) + ")"; })
                      .on("mouseover", function (d) {
                        d3.select(this).classed("sensebox hovered", true);
                        creatediagram(d.boxId);
                      })
                      .on("mouseout", function (d) {
                        d3.select(this).classed("parts hovered", false);
                        svg2.selectAll("*").remove();
                      });
            
                      //function to create my linediagram
                    function creatediagram(Box) {
                      console.log("Current BoxId: " + Box);
            
                      var currentsensor = new Object();
                      //console.log(currentsensor);
                      cdataset.forEach(function (obj) {
            
                        if (parseInt(obj.boxId) == parseInt(Box)) {
                          currentsensor = obj;
                        }
                      });
            
                      if (currentsensor == undefined || currentsensor == null || Object.keys(currentsensor).length === 0) {
                        console.log("No information available");
                        svg2.append("text").text("No information available");
                      }
                      else {
                        console.log(currentsensor);
                        var dataitem = formatObject(currentsensor);
                        console.log(dataitem);
            
                        // creating x and y scale
                        var xScale = d3.scaleBand().rangeRound([40, width2]),
                          yScale = d3.scaleLinear().rangeRound([height2, 0]);
            
                        // d3's line generator
                        var line = d3.line()
                          .x(function(d) { return xScale(d[0]); }) 
                          .y(function(d) { return yScale(d[1]); })
                          // set the y values for the line generator 
                          .curve(d3.curveMonotoneX); // apply smoothing to the line
                          
                          console.log(dataitem[1])
                          xScale.domain(dataitem.map(function (d) { return d[0]; })),
                          yScale.domain([0, d3.max(dataitem, function (d) { return d[1]; })]);
            
                        // add x axis
                        svg2.append("g")
                          .attr("class", "axis axis--x")
                          .attr("transform", "translate(-40, 460)") // Set the position from my x axis
                          .call(d3.axisBottom(xScale)); 
            
                        // y axis is added 
                        svg2.append("g")
                          .attr("class", "axis axis--y")
                          .attr("transform", "translate(40, 0)")// Set the position from my y axis
                          .call(d3.axisLeft(yScale));
                        
                        //for my y axis i added a name
                        svg2.append("text") 
                          .attr("transform", "translate(8,-5)")
                          .text("Luftdruck");
            
                        // Append the path, bind the data, and call the line generator 
                        svg2.append("path")
                          .datum(dataitem) // Binds data to the line 
                          .attr("d", line) //  Calls the line generator
                          .attr("class", "line"); // Assign a class for styling 
            
                        // For some styling i added Points for better reading
                        svg2.selectAll(".dot")
                          .data(dataitem)
                          .enter()
                          .append("circle") 
                          .attr("class", "dot") // Assign a class for styling
                          .attr("cx", function(d) { return xScale(d[0]) })
                          .attr("cy", function (d) { return yScale(d[1]) })
                          .attr("r", 5)
                          .attr("fill", "#FFD700")
                          .attr("r", 3);
                         }
                    }
                    // go through the whole data item for a city, and only keep the values from 
                    var formatObject = function (rawdataobject) {
                      var formattedObject = new Array();
            
                      for (var key in rawdataobject) {
                        // pick only values for some of the years
                        if (key == "2018-11-11T23Z" || key == "2018-11-12T00Z" || key == "2018-11-12T01Z"
                          || key == "2018-11-12T02Z" || key == "2018-11-12T03Z" || key == "2018-11-12T04Z"
                          || key == "2018-11-12T05Z" || key == "2018-11-12T06Z" || key == "2018-11-12T07Z" 
                          || key == "2018-11-12T08Z") {
            
                          var value = parseFloat(rawdataobject[key].replace(/\s/g, ''));
                          var temp = new Array(key, value);
                          //console.log(temp);
                          formattedObject.push(temp);
                        }
                        else {
                          continue;
                        }
                      }
                      return formattedObject;
                    }
                  }),
            
                  function (error) { console.log(error); }
              },
                function (error) { console.log(error); }
              );
            
         </script>
      </body>
   </html>